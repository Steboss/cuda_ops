name: Build and Push Docker Image

on:
    workflow_call:
        inputs:
            package-base-version:
                description: Python Package version
                required: true
                type: string
            package-dev-version:
                description: The Dev Python Package version
                required: true
                type: string
        secrets:
            DOCKERHUB_USERNAME:
                required: true
            DOCKERHUB_TOKEN:
                required: true

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                ref: ${{ github.event_name == 'pull_request' && github.event.inputs.base_ref || github.ref }}
                fetch-depth: 0

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to DockerHub
              run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            - name: Build and Push Docker Image
              run: |
                docker buildx build --platform linux/amd64,linux/arm64 \
                -t ${{ secrets.DOCKERHUB_USERNAME}}/cuda_ops:${{ inputs.package-dev-version }} -f Dockerfile . --push

            # Run tests inside the Docker container with GPU access in case we can move the push later
            - name: Run tests inside Docker container
              run: |
                docker run --gpus all ${{ secrets.DOCKERHUB_USERNAME}}/cuda_ops:${{ inputs.package-dev-version }} bash -c "pytest -s /opt/cuda_ops/test/test.py"
