---
name: On push to main branch

on:
    push:
        branches:
            - 'main'

permissions:
    id-token: write
    contents: write

jobs:

    push-python-package-main:
        uses: ./.github/workflows/push_python_package.yml
        secrets:
            PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
            PYPI: ${{ secrets.PYPI }}
            TOKEN: ${{ secrets.TOKEN }}


    build-and-push-image:
        needs: push-python-package-main
        uses: ./.github/workflows/build_and_push_image.yml
        with:
            package-base-version: ${{ needs.push-python-package-main.outputs.package-base-version }}
            package-dev-version: ${{ needs.push-python-package-main.outputs.package-dev-version }}
        secrets:
            DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
            DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    create-release:
        needs: push-python-package-main
        runs-on: ubuntu-latest
        outputs:
            new_tag: ${{ steps.tag-version.outputs.new_tag}}

        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0
            - name: Compute new version based on semantic
              id: tag-version
              uses: mathieudutour/github-tag-action@v6.1
              with:
                custom_tag: ${{ needs.push-python-package-main.outputs.package-base-version }}
                github_token: ${{ secrets.TOKEN }}
            - name: Create GH Release
              uses: ncipollo/release-action@v1
              with:
                tag: ${{ steps.tag-version.outputs.new_tag }}
                name: ${{ steps.tag-version.outputs.new_tag }}
                body: ${{ steps.tag-version.outputs.changelog }}
